name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:  # Allow manual triggers

# Prevent concurrent deployments
concurrency:
  group: production-deployment
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: ${{ github.repository_owner }}

jobs:
  # Job 1: Detect what changed
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      docker: ${{ steps.changes.outputs.docker }}
      deploy: ${{ steps.changes.outputs.deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect file changes
        id: changes
        run: |
          # Get list of changed files
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - deploy everything
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "docker=true" >> $GITHUB_OUTPUT
            echo "deploy=true" >> $GITHUB_OUTPUT
            echo "üì¶ Manual trigger - deploying all services"
          else
            # Check for changes in specific paths
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)

            echo "Changed files:"
            echo "$CHANGED_FILES"

            # Check frontend changes
            if echo "$CHANGED_FILES" | grep -qE '^frontend/|^\.github/workflows/'; then
              echo "frontend=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Frontend changes detected"
            else
              echo "frontend=false" >> $GITHUB_OUTPUT
              echo "‚è≠Ô∏è  No frontend changes"
            fi

            # Check backend changes
            if echo "$CHANGED_FILES" | grep -qE '^backend/|^\.github/workflows/'; then
              echo "backend=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Backend changes detected"
            else
              echo "backend=false" >> $GITHUB_OUTPUT
              echo "‚è≠Ô∏è  No backend changes"
            fi

            # Check docker/nginx changes
            if echo "$CHANGED_FILES" | grep -qE '^docker-compose\.prod\.yml|^nginx/|^\.env\.example'; then
              echo "docker=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Docker/Nginx changes detected"
            else
              echo "docker=false" >> $GITHUB_OUTPUT
              echo "‚è≠Ô∏è  No docker changes"
            fi

            # Deploy if any service changed
            if echo "$CHANGED_FILES" | grep -qE '^frontend/|^backend/|^docker-compose\.prod\.yml|^nginx/|^scripts/'; then
              echo "deploy=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Deployment required"
            else
              echo "deploy=false" >> $GITHUB_OUTPUT
              echo "‚è≠Ô∏è  No deployment needed"
            fi
          fi

  # Job 2: Run Tests (Frontend)
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm run test

      - name: Build check
        run: npm run build
        env:
          NEXT_PUBLIC_STRAPI_URL: http://localhost:1337
          NEXT_PUBLIC_SITE_URL: http://localhost:3000

  # Job 3: Run Tests (Backend)
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test

  # Job 4: Build and Push Frontend Image
  build-frontend:
    name: Build & Push Frontend
    runs-on: ubuntu-latest
    needs: [detect-changes, test-frontend]
    if: |
      always() &&
      needs.detect-changes.outputs.frontend == 'true' &&
      (needs.test-frontend.result == 'success' || needs.test-frontend.result == 'skipped')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/bcflame-frontend
          tags: |
            type=sha,prefix=,format=long
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_STRAPI_URL=${{ secrets.NEXT_PUBLIC_STRAPI_URL }}
            NEXT_PUBLIC_SITE_URL=${{ secrets.NEXT_PUBLIC_SITE_URL }}

  # Job 5: Build and Push Backend Image
  build-backend:
    name: Build & Push Backend
    runs-on: ubuntu-latest
    needs: [detect-changes, test-backend]
    if: |
      always() &&
      needs.detect-changes.outputs.backend == 'true' &&
      (needs.test-backend.result == 'success' || needs.test-backend.result == 'skipped')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/bcflame-backend
          tags: |
            type=sha,prefix=,format=long
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            PUBLIC_URL=${{ secrets.NEXT_PUBLIC_STRAPI_URL }}

  # Job 6: Deploy to Production Server
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [detect-changes, build-frontend, build-backend]
    if: |
      always() &&
      needs.detect-changes.outputs.deploy == 'true' &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Determine which service to deploy
        id: service
        run: |
          FRONTEND="${{ needs.detect-changes.outputs.frontend }}"
          BACKEND="${{ needs.detect-changes.outputs.backend }}"

          if [ "$FRONTEND" = "true" ] && [ "$BACKEND" = "true" ]; then
            echo "service=both" >> $GITHUB_OUTPUT
            echo "üì¶ Deploying both frontend and backend"
          elif [ "$FRONTEND" = "true" ]; then
            echo "service=frontend" >> $GITHUB_OUTPUT
            echo "üì¶ Deploying frontend only"
          elif [ "$BACKEND" = "true" ]; then
            echo "service=backend" >> $GITHUB_OUTPUT
            echo "üì¶ Deploying backend only"
          else
            echo "service=both" >> $GITHUB_OUTPUT
            echo "üì¶ Deploying both (docker/nginx changes)"
          fi

      - name: Deploy to server
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ secrets.SERVER_PROJECT_PATH }} && \
             ./scripts/deploy.sh ${{ steps.service.outputs.service }} ${{ github.sha }}"

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ secrets.SERVER_PROJECT_PATH }} && \
             ./scripts/verify-deployment.sh"

      - name: Cleanup SSH
        if: always()
        run: rm -f ~/.ssh/deploy_key

  # Job 7: Notify Discord (Optional)
  notify:
    name: Notify Discord
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && secrets.DISCORD_WEBHOOK != ''
    steps:
      - name: Send Discord notification
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            COLOR="3066993"
            TITLE="‚úÖ Deployment Successful"
            DESCRIPTION="Deployment to production completed successfully"
          else
            COLOR="15158332"
            TITLE="‚ùå Deployment Failed"
            DESCRIPTION="Deployment to production failed. Check logs for details."
          fi

          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"description\": \"$DESCRIPTION\",
                \"color\": $COLOR,
                \"fields\": [
                  {
                    \"name\": \"Commit\",
                    \"value\": \"[\`${GITHUB_SHA:0:7}\`]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/$GITHUB_SHA)\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Branch\",
                    \"value\": \"$GITHUB_REF_NAME\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Author\",
                    \"value\": \"$GITHUB_ACTOR\",
                    \"inline\": true
                  }
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }"
